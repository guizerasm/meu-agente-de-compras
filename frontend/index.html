<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0f766e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Agente de Compras - IA</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --bg: #f1f5f9;
      --white: #ffffff;
      --gray-100: #f8fafc;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-500: #64748b;
      --gray-700: #334155;
      --gray-900: #0f172a;
      --success: #22c55e;
      --warning: #f59e0b;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    #app {
      display: flex;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    /* ===== SIDEBAR (Desktop) ===== */
    .sidebar {
      width: 320px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .sidebar-header h2 {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sidebar-header h1 {
      font-size: 22px;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .sidebar-content h3 {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    #lista-desktop {
      display: none;
    }

    #lista-desktop.visible {
      display: block;
    }

    .lista-item {
      background: var(--gray-100);
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid var(--primary);
    }

    .lista-item-name {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .lista-item-details {
      font-size: 12px;
      color: var(--gray-500);
    }

    .empty-state {
      text-align: center;
      color: var(--gray-500);
      padding: 40px 20px;
      font-size: 14px;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--gray-200);
    }

    .sidebar-footer button {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .sidebar-footer button:hover {
      background: var(--primary-light);
    }

    .sidebar-footer button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== MAIN AREA ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      box-shadow: 0 2px 10px rgba(15, 118, 110, 0.2);
    }

    header h1 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      background: rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.ready { background: rgba(34, 197, 94, 0.4); }
    .badge.loading { background: rgba(251, 191, 36, 0.4); }

    /* Chat */
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      background: var(--gray-100);
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .msg-row {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }

    .msg-row.user {
      flex-direction: row-reverse;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      background: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .msg-row.user .avatar {
      background: var(--gray-500);
    }

    .msg {
      max-width: 600px;
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg-row.bot .msg {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-bottom-left-radius: 4px;
    }

    .msg-row.user .msg {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
    }

    /* Typing */
    .typing {
      display: flex;
      gap: 5px;
      padding: 14px 18px;
      background: var(--white);
      border-radius: 18px;
      width: fit-content;
    }

    .typing span {
      width: 10px;
      height: 10px;
      background: var(--gray-300);
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    /* Lista Mobile (dentro do chat) */
    #lista-mobile {
      display: none;
      background: var(--white);
      border-top: 2px solid var(--primary);
      max-height: 40%;
      overflow-y: auto;
      flex-shrink: 0;
    }

    #lista-mobile.visible {
      display: block;
    }

    #lista-mobile-header {
      padding: 14px 20px;
      background: var(--gray-100);
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
    }

    #lista-mobile-content {
      padding: 16px 20px;
    }

    /* Footer */
    footer {
      background: var(--white);
      border-top: 1px solid var(--gray-200);
      padding: 16px 24px;
      padding-bottom: max(16px, var(--safe-bottom));
      flex-shrink: 0;
    }

    .input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid var(--gray-200);
      border-radius: 28px;
      font-size: 16px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      min-height: 52px;
      transition: all 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    .btn {
      height: 52px;
      min-width: 52px;
      border: none;
      border-radius: 26px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      padding: 0 20px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3); }
    .btn-primary:active { transform: translateY(0); }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn-secondary:hover { background: var(--gray-300); }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-icon {
      padding: 0;
      width: 52px;
    }

    input[type="file"] {
      display: none;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }

      header h1 {
        font-size: 18px;
      }

      #chat {
        padding: 16px;
        gap: 12px;
      }

      .avatar {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .msg {
        max-width: 80%;
        padding: 12px 16px;
        font-size: 14px;
      }

      footer {
        padding: 12px 16px;
        padding-bottom: max(12px, var(--safe-bottom));
      }

      .input-container {
        flex-wrap: wrap;
        gap: 10px;
      }

      textarea {
        flex: 1 1 100%;
        min-height: 48px;
        padding: 12px 18px;
        font-size: 16px;
      }

      .btn-group {
        width: 100%;
        justify-content: space-between;
      }

      .btn {
        flex: 1;
        height: 48px;
        min-width: auto;
        font-size: 14px;
        padding: 0 14px;
      }

      .btn-icon {
        flex: 0 0 48px;
        width: 48px;
      }

      .btn span.label {
        display: none;
      }
    }

    @media (max-width: 400px) {
      header {
        padding: 12px 16px;
      }

      header h1 {
        font-size: 16px;
      }

      .badge {
        padding: 4px 10px;
        font-size: 11px;
      }

      #chat {
        padding: 12px;
      }

      .msg {
        max-width: 85%;
        padding: 10px 14px;
        font-size: 13px;
      }

      .btn {
        height: 44px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<div id="app">
  <!-- Sidebar (Desktop Only) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Assistente IA</h2>
      <h1>üõí Agente de Compras</h1>
    </div>
    <div class="sidebar-content">
      <h3>üìã Lista de Compras</h3>
      <div id="lista-desktop">
        <!-- Items ser√£o inseridos aqui -->
      </div>
      <div id="empty-state" class="empty-state">
        A lista aparecer√° aqui quando estiver pronta
      </div>
    </div>
    <div class="sidebar-footer">
      <button id="baixarPdfDesktop" disabled>üì• Baixar PDF da Lista</button>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main">
    <header>
      <h1>üõí Agente de Compras</h1>
      <span class="badge ready" id="status">Pronto</span>
    </header>

    <div id="chat-area">
      <div id="chat"></div>
    </div>

    <!-- Lista Mobile -->
    <div id="lista-mobile">
      <div id="lista-mobile-header">
        <span>üìã Lista de Compras</span>
        <button id="baixarPdfMobile" class="btn btn-primary" style="height:36px;padding:0 14px;font-size:13px;">üì• PDF</button>
      </div>
      <div id="lista-mobile-content"></div>
    </div>

    <footer>
      <div class="input-container">
        <textarea id="input" rows="1" placeholder="Digite sua dieta aqui..."></textarea>
        <div class="btn-group">
          <button class="btn btn-secondary" id="pdfBtn">üìÑ <span class="label">PDF</span></button>
          <input type="file" id="pdf" accept="application/pdf" />
          <button class="btn btn-primary btn-icon" id="send">‚û§</button>
          <button class="btn btn-success" id="finalizar" disabled>‚úì <span class="label">Finalizar</span></button>
        </div>
      </div>
    </footer>
  </div>
</div>

<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const pdfInput = document.getElementById("pdf");
  const pdfBtn = document.getElementById("pdfBtn");
  const finalizarBtn = document.getElementById("finalizar");
  const statusBadge = document.getElementById("status");

  // Listas
  const listaDesktop = document.getElementById("lista-desktop");
  const listaMobile = document.getElementById("lista-mobile");
  const listaMobileContent = document.getElementById("lista-mobile-content");
  const emptyState = document.getElementById("empty-state");
  const baixarPdfDesktop = document.getElementById("baixarPdfDesktop");
  const baixarPdfMobile = document.getElementById("baixarPdfMobile");

  const API_URL = window.location.origin;
  let dieta = null;
  let historico = [];
  let listaFinal = null;
  let fase = "inicial";

  function setStatus(text, type) {
    statusBadge.textContent = text;
    statusBadge.className = "badge " + type;
  }

  function addMessage(text, isUser = false) {
    const row = document.createElement("div");
    row.className = "msg-row " + (isUser ? "user" : "bot");

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = isUser ? "üë§" : "ü§ñ";

    const msg = document.createElement("div");
    msg.className = "msg";
    msg.textContent = text;

    row.appendChild(avatar);
    row.appendChild(msg);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function showTyping() {
    const row = document.createElement("div");
    row.className = "msg-row bot";
    row.id = "typing";

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = "ü§ñ";

    const typing = document.createElement("div");
    typing.className = "typing";
    typing.innerHTML = "<span></span><span></span><span></span>";

    row.appendChild(avatar);
    row.appendChild(typing);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function hideTyping() {
    const t = document.getElementById("typing");
    if (t) t.remove();
  }

  function renderLista(lista) {
    const html = lista.map((item, i) => `
      <div class="lista-item">
        <div class="lista-item-name">${i+1}. ${item.nome || item.item}</div>
        <div class="lista-item-details">Quantidade: ${item.quantidade} | ${item.motivo || ""}</div>
      </div>
    `).join("");

    listaDesktop.innerHTML = html;
    listaMobileContent.innerHTML = html;

    listaDesktop.classList.add("visible");
    listaMobile.classList.add("visible");
    emptyState.style.display = "none";
    baixarPdfDesktop.disabled = false;
  }

  async function enviarDietaInicial() {
    const form = new FormData();

    if (pdfInput.files.length > 0) {
      form.append("file", pdfInput.files[0]);
      addMessage("üìÑ " + pdfInput.files[0].name, true);
    } else if (input.value.trim()) {
      form.append("texto", input.value.trim());
      addMessage(input.value.trim(), true);
    } else {
      return;
    }

    input.value = "";
    pdfInput.value = "";
    setStatus("Processando...", "loading");
    showTyping();

    try {
      const res = await fetch(API_URL + "/dieta", { method: "POST", body: form });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      dieta = data.dieta;
      historico = [];
      fase = data.escolhas_pendentes ? "conversando" : "pronto";

      addMessage(data.mensagem);
      setStatus(fase === "pronto" ? "Pronto!" : "Conversando", fase === "pronto" ? "ready" : "loading");
      if (fase === "pronto") finalizarBtn.disabled = false;
    } catch (e) {
      hideTyping();
      addMessage("‚ùå Erro: " + e.message);
      setStatus("Erro", "");
    }
  }

  async function enviarMensagemChat() {
    const texto = input.value.trim();
    if (!texto) return;

    addMessage(texto, true);
    input.value = "";
    setStatus("Processando...", "loading");
    showTyping();

    try {
      const res = await fetch(API_URL + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dieta, historico, mensagem_usuario: texto })
      });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      historico = data.historico;
      if (data.dieta_atualizada) dieta = data.dieta_atualizada;

      addMessage(data.resposta);

      // Verificar prontid√£o
      const check = await fetch(API_URL + "/verificar-prontidao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dieta })
      });
      const checkData = await check.json();

      if (checkData.pronto) {
        fase = "pronto";
        finalizarBtn.disabled = false;
        setStatus("Pronto!", "ready");
      } else {
        setStatus("Conversando", "loading");
      }
    } catch (e) {
      hideTyping();
      addMessage("‚ùå Erro: " + e.message);
      setStatus("Erro", "");
    }
  }

  async function finalizarLista() {
    addMessage("Quero finalizar a lista de compras.", true);
    setStatus("Gerando lista...", "loading");
    showTyping();

    try {
      const res = await fetch(API_URL + "/finalizar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dieta_final: dieta })
      });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      listaFinal = data.lista_compras;

      if (data.avisos && data.avisos.length > 0) {
        addMessage("‚ö†Ô∏è " + data.avisos.join("\n"));
      }

      renderLista(listaFinal);
      addMessage("üéâ Lista pronta! Confira ao lado (desktop) ou acima (mobile).");
      setStatus("Conclu√≠do", "ready");
      finalizarBtn.disabled = true;
    } catch (e) {
      hideTyping();
      addMessage("‚ùå Erro: " + e.message);
      setStatus("Erro", "");
    }
  }

  async function baixarPdf() {
    if (!listaFinal) return;
    try {
      const res = await fetch(API_URL + "/gerar-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lista_compras: listaFinal })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "lista_compras.pdf";
      a.click();
      URL.revokeObjectURL(url);
      addMessage("üì• PDF baixado!");
    } catch (e) {
      addMessage("‚ùå Erro ao gerar PDF");
    }
  }

  // Event Listeners
  sendBtn.onclick = () => fase === "inicial" ? enviarDietaInicial() : enviarMensagemChat();
  input.onkeydown = (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }};
  finalizarBtn.onclick = finalizarLista;
  pdfBtn.onclick = () => pdfInput.click();
  pdfInput.onchange = () => { if (pdfInput.files.length && fase === "inicial") enviarDietaInicial(); };
  baixarPdfDesktop.onclick = baixarPdf;
  baixarPdfMobile.onclick = baixarPdf;

  // Auto-resize textarea
  input.oninput = () => { input.style.height = "auto"; input.style.height = Math.min(input.scrollHeight, 120) + "px"; };

  // Mensagem inicial
  addMessage("üëã Ol√°! Eu sou seu assistente de compras com IA.\n\nüìù Envie sua dieta em texto ou PDF, e vamos conversar para confirmar suas prefer√™ncias.\n\nüõí Depois vou gerar uma lista de compras completa e otimizada para voc√™!");

  // Health check
  fetch(API_URL + "/health").catch(() => addMessage("‚ö†Ô∏è Servidor offline. Execute: python server.py"));
</script>

</body>
</html>
