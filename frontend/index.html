<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#059669" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Agente de Compras IA</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #059669;
      --primary-dark: #047857;
      --primary-light: #10b981;
      --accent: #f59e0b;
      --bg: #f0fdf4;
      --bg-dark: #ecfdf5;
      --white: #ffffff;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    #app {
      display: flex;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    /* ===== SIDEBAR (Desktop) ===== */
    .sidebar {
      width: 340px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
    }

    .sidebar-header h1 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header p {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-section h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #lista-desktop {
      display: none;
    }

    #lista-desktop.visible {
      display: block;
    }

    .lista-item {
      background: var(--gray-50);
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 10px;
      border-left: 4px solid var(--primary);
      transition: all 0.2s;
    }

    .lista-item:hover {
      background: var(--bg-dark);
      transform: translateX(4px);
    }

    .lista-item-name {
      font-weight: 600;
      color: var(--gray-800);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .lista-item-qty {
      font-size: 13px;
      color: var(--primary-dark);
      font-weight: 500;
    }

    .lista-item-reason {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .empty-state {
      text-align: center;
      color: var(--gray-400);
      padding: 40px 20px;
      font-size: 14px;
    }

    .empty-state span {
      font-size: 40px;
      display: block;
      margin-bottom: 12px;
    }

    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .btn-download {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-download:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-download:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== MAIN AREA ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
      background: var(--bg);
    }

    /* Header */
    header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      border-bottom: 1px solid var(--gray-200);
    }

    header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .status.ready {
      background: #dcfce7;
      color: #166534;
    }

    .status.loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Chat */
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      -webkit-overflow-scrolling: touch;
    }

    .msg-row {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }

    .msg-row.user {
      flex-direction: row-reverse;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      box-shadow: var(--shadow);
    }

    .msg-row.bot .avatar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    }

    .msg-row.user .avatar {
      background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-500) 100%);
    }

    .msg {
      max-width: 70%;
      padding: 16px 20px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg-row.bot .msg {
      background: var(--white);
      color: var(--gray-800);
      box-shadow: var(--shadow-sm);
      border-bottom-left-radius: 6px;
    }

    .msg-row.user .msg {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border-bottom-right-radius: 6px;
    }

    /* Typing indicator */
    .typing {
      display: flex;
      gap: 5px;
      padding: 16px 20px;
      background: var(--white);
      border-radius: 20px;
      width: fit-content;
      box-shadow: var(--shadow-sm);
    }

    .typing span {
      width: 10px;
      height: 10px;
      background: var(--gray-300);
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }

    /* Tutorial Card */
    .tutorial-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border-radius: 20px;
      padding: 24px;
      margin: 0 auto;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
    }

    .tutorial-card h2 {
      font-size: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tutorial-steps {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .tutorial-step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: rgba(255,255,255,0.15);
      padding: 14px;
      border-radius: 12px;
    }

    .step-num {
      width: 28px;
      height: 28px;
      background: white;
      color: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }

    .step-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .step-text strong {
      display: block;
      font-size: 15px;
      margin-bottom: 2px;
    }

    .tutorial-card .btn-start {
      width: 100%;
      margin-top: 20px;
      padding: 14px;
      background: white;
      color: var(--primary);
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tutorial-card .btn-start:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow);
    }

    /* Lista Mobile */
    #lista-mobile {
      display: none;
      background: var(--white);
      border-top: 3px solid var(--primary);
      max-height: 45%;
      overflow-y: auto;
      flex-shrink: 0;
    }

    #lista-mobile.visible {
      display: block;
    }

    #lista-mobile-header {
      padding: 16px 20px;
      background: var(--gray-50);
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--gray-200);
    }

    #lista-mobile-content {
      padding: 16px 20px;
    }

    /* Footer */
    footer {
      background: var(--white);
      border-top: 1px solid var(--gray-200);
      padding: 16px 24px;
      padding-bottom: max(16px, var(--safe-bottom));
      flex-shrink: 0;
    }

    .input-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid var(--gray-200);
      border-radius: 24px;
      font-size: 16px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      min-height: 52px;
      transition: all 0.2s;
      background: var(--gray-50);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
    }

    textarea::placeholder {
      color: var(--gray-400);
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    .btn {
      height: 52px;
      min-width: 52px;
      border: none;
      border-radius: 26px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      padding: 0 20px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(5, 150, 105, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-icon {
      padding: 0;
      width: 52px;
    }

    input[type="file"] {
      display: none;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }

      header {
        padding: 14px 16px;
      }

      header h1 {
        font-size: 16px;
      }

      .status {
        padding: 6px 12px;
        font-size: 12px;
      }

      #chat {
        padding: 16px;
        gap: 16px;
      }

      .avatar {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .msg {
        max-width: 82%;
        padding: 14px 16px;
        font-size: 14px;
      }

      .tutorial-card {
        margin: 0 8px;
        padding: 20px;
      }

      .tutorial-card h2 {
        font-size: 18px;
      }

      .tutorial-step {
        padding: 12px;
      }

      footer {
        padding: 12px 16px;
        padding-bottom: max(12px, var(--safe-bottom));
      }

      .input-row {
        flex-wrap: wrap;
        gap: 10px;
      }

      textarea {
        flex: 1 1 100%;
        min-height: 48px;
        padding: 12px 18px;
      }

      .btn-group {
        width: 100%;
        justify-content: space-between;
      }

      .btn {
        flex: 1;
        height: 48px;
        min-width: auto;
        font-size: 14px;
        padding: 0 16px;
      }

      .btn-icon {
        flex: 0 0 48px;
        width: 48px;
      }

    }

    @media (max-width: 400px) {
      header h1 {
        font-size: 14px;
      }

      .msg {
        max-width: 88%;
        padding: 12px 14px;
        font-size: 13px;
        border-radius: 16px;
      }

      .btn {
        height: 44px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<div id="app">
  <!-- Sidebar (Desktop Only) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Agente de Compras</h1>
      <p>Sua lista inteligente com IA</p>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-section">
        <h3>Lista de Compras</h3>
        <div id="lista-desktop"></div>
        <div id="empty-state" class="empty-state">
          <span>ðŸ›’</span>
          Sua lista aparecera aqui<br>quando estiver pronta
        </div>
      </div>
    </div>
    <div class="sidebar-footer">
      <button id="baixarPdfDesktop" class="btn-download" disabled>
        Baixar Lista em PDF
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main">
    <header>
      <h1>Agente de Compras</h1>
      <div class="status ready" id="status">
        <span class="status-dot"></span>
        <span id="status-text">Pronto</span>
      </div>
    </header>

    <div id="chat-area">
      <div id="chat"></div>
    </div>

    <!-- Lista Mobile -->
    <div id="lista-mobile">
      <div id="lista-mobile-header">
        <span>Lista de Compras</span>
        <button id="baixarPdfMobile" class="btn btn-primary" style="height:38px;padding:0 16px;font-size:13px;">PDF</button>
      </div>
      <div id="lista-mobile-content"></div>
    </div>

    <footer>
      <div class="input-row">
        <textarea id="input" rows="1" placeholder="Cole sua dieta aqui ou envie um PDF..."></textarea>
        <div class="btn-group">
          <button class="btn btn-secondary" id="pdfBtn" title="Enviar PDF">
            Enviar PDF
          </button>
          <input type="file" id="pdf" accept="application/pdf" />
          <button class="btn btn-primary btn-icon" id="send" title="Enviar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
      </div>
    </footer>
  </div>
</div>

<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const pdfInput = document.getElementById("pdf");
  const pdfBtn = document.getElementById("pdfBtn");
  const statusDiv = document.getElementById("status");
  const statusText = document.getElementById("status-text");

  const listaDesktop = document.getElementById("lista-desktop");
  const listaMobile = document.getElementById("lista-mobile");
  const listaMobileContent = document.getElementById("lista-mobile-content");
  const emptyState = document.getElementById("empty-state");
  const baixarPdfDesktop = document.getElementById("baixarPdfDesktop");
  const baixarPdfMobile = document.getElementById("baixarPdfMobile");

  const API_URL = window.location.origin;
  let dieta = null;
  let historico = [];
  let listaFinal = null;
  let fase = "tutorial";
  let tutorialShown = false;

  function setStatus(text, type) {
    statusText.textContent = text;
    statusDiv.className = "status " + type;
  }

  function addMessage(text, isUser = false) {
    const row = document.createElement("div");
    row.className = "msg-row " + (isUser ? "user" : "bot");

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = isUser ? "ðŸ‘¤" : "ðŸ¤–";

    const msg = document.createElement("div");
    msg.className = "msg";
    msg.textContent = text;

    row.appendChild(avatar);
    row.appendChild(msg);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function showTyping() {
    const row = document.createElement("div");
    row.className = "msg-row bot";
    row.id = "typing";

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = "ðŸ¤–";

    const typing = document.createElement("div");
    typing.className = "typing";
    typing.innerHTML = "<span></span><span></span><span></span>";

    row.appendChild(avatar);
    row.appendChild(typing);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function hideTyping() {
    const t = document.getElementById("typing");
    if (t) t.remove();
  }

  function showTutorial() {
    const tutorialHTML = `
      <div class="tutorial-card">
        <h2>Como funciona</h2>
        <div class="tutorial-steps">
          <div class="tutorial-step">
            <span class="step-num">1</span>
            <div class="step-text">
              <strong>Envie sua dieta</strong>
              Cole o texto da sua dieta ou envie um PDF do nutricionista
            </div>
          </div>
          <div class="tutorial-step">
            <span class="step-num">2</span>
            <div class="step-text">
              <strong>Responda rapidinho</strong>
              Vou perguntar quantas pessoas e se tem algo em casa
            </div>
          </div>
          <div class="tutorial-step">
            <span class="step-num">3</span>
            <div class="step-text">
              <strong>Lista pronta!</strong>
              Gero automaticamente sua lista com quantidades certas
            </div>
          </div>
        </div>
        <button class="btn-start" onclick="startChat()">Comecar</button>
      </div>
    `;

    const wrapper = document.createElement("div");
    wrapper.id = "tutorial-wrapper";
    wrapper.innerHTML = tutorialHTML;
    chat.appendChild(wrapper);
  }

  function startChat() {
    const tutorial = document.getElementById("tutorial-wrapper");
    if (tutorial) tutorial.remove();

    fase = "inicial";
    tutorialShown = true;
    addMessage("Ola! Cole sua dieta no campo abaixo ou envie um PDF. Vou transformar em uma lista de compras completa!");
    input.focus();
  }

  function renderLista(lista) {
    const html = lista.map((item, i) => `
      <div class="lista-item">
        <div class="lista-item-name">${i+1}. ${item.nome || item.item}</div>
        <div class="lista-item-qty">${item.quantidade}</div>
        <div class="lista-item-reason">${item.motivo || ""}</div>
      </div>
    `).join("");

    listaDesktop.innerHTML = html;
    listaMobileContent.innerHTML = html;

    listaDesktop.classList.add("visible");
    listaMobile.classList.add("visible");
    emptyState.style.display = "none";
    baixarPdfDesktop.disabled = false;
  }

  async function enviarDietaInicial() {
    const form = new FormData();

    if (pdfInput.files.length > 0) {
      form.append("file", pdfInput.files[0]);
      addMessage("PDF: " + pdfInput.files[0].name, true);
    } else if (input.value.trim()) {
      form.append("texto", input.value.trim());
      addMessage(input.value.trim(), true);
    } else {
      return;
    }

    input.value = "";
    pdfInput.value = "";
    setStatus("Analisando...", "loading");
    showTyping();

    try {
      const res = await fetch(API_URL + "/dieta", { method: "POST", body: form });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      dieta = data.dieta;
      historico = [];
      fase = "conversando";

      addMessage(data.mensagem);
      setStatus("Conversando", "loading");

      // Iniciar conversa automaticamente
      setTimeout(() => iniciarConversaAutomatica(), 500);

    } catch (e) {
      hideTyping();
      addMessage("Erro: " + e.message);
      setStatus("Erro", "");
    }
  }

  async function iniciarConversaAutomatica() {
    // Envia primeira pergunta automaticamente
    showTyping();

    try {
      const res = await fetch(API_URL + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          dieta,
          historico,
          mensagem_usuario: "Recebi minha dieta, pode me ajudar com a lista?"
        })
      });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      historico = data.historico;
      if (data.dieta_atualizada) dieta = data.dieta_atualizada;

      // Limpar tag [LISTA_PRONTA] antes de mostrar
      const respostaLimpa = data.resposta.replace("[LISTA_PRONTA]", "").trim();
      addMessage(respostaLimpa);

      // Verificar se ja esta pronto para gerar lista
      if (data.resposta.includes("[LISTA_PRONTA]")) {
        await gerarListaAutomatica();
      }

    } catch (e) {
      hideTyping();
      addMessage("Erro: " + e.message);
    }
  }

  async function enviarMensagemChat() {
    const texto = input.value.trim();
    if (!texto) return;

    addMessage(texto, true);
    input.value = "";
    setStatus("Processando...", "loading");
    showTyping();

    try {
      const res = await fetch(API_URL + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dieta, historico, mensagem_usuario: texto })
      });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      historico = data.historico;
      if (data.dieta_atualizada) dieta = data.dieta_atualizada;

      // Limpar tag [LISTA_PRONTA] antes de mostrar
      const respostaLimpa = data.resposta.replace("[LISTA_PRONTA]", "").trim();
      addMessage(respostaLimpa);

      // Verificar se esta pronto para gerar lista automaticamente
      if (data.resposta.includes("[LISTA_PRONTA]")) {
        setStatus("Gerando lista...", "loading");
        await gerarListaAutomatica();
      } else if (fase === "ajustar") {
        // Usuario esta ajustando a lista - regenerar
        setStatus("Atualizando lista...", "loading");
        await gerarListaAutomatica();
      } else {
        setStatus("Conversando", "loading");
      }

    } catch (e) {
      hideTyping();
      addMessage("Erro: " + e.message);
      setStatus("Erro", "");
    }
  }

  async function gerarListaAutomatica() {
    showTyping();

    try {
      const res = await fetch(API_URL + "/finalizar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dieta_final: dieta })
      });
      const data = await res.json();
      hideTyping();

      if (data.erro) throw new Error(data.erro);

      listaFinal = data.lista_compras;

      if (data.avisos && data.avisos.length > 0) {
        addMessage("Avisos: " + data.avisos.join("\n"));
      }

      renderLista(listaFinal);

      if (fase === "ajustar") {
        // Estava ajustando - mostrar mensagem de atualizacao
        addMessage("Lista atualizada! Quer ajustar mais alguma coisa?");
        mostrarOpcaoAjustar();
      } else {
        // Primeira geracao
        addMessage("Pronto! Sua lista de compras esta na lateral (desktop) ou acima (mobile). Pode baixar o PDF!");
        mostrarOpcaoAjustar();
      }

      setStatus("Lista pronta!", "ready");
      fase = "ajustar";

    } catch (e) {
      hideTyping();
      addMessage("Erro ao gerar lista: " + e.message);
      setStatus("Erro", "");
    }
  }

  function mostrarOpcaoAjustar() {
    const row = document.createElement("div");
    row.className = "msg-row bot";
    row.id = "ajuste-opcao";

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = "ðŸ¤–";

    const msgDiv = document.createElement("div");
    msgDiv.className = "msg";
    msgDiv.innerHTML = `
      <div style="margin-bottom:12px">Quer ajustar alguma coisa na lista?</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="continuarConversa()" style="padding:10px 16px;background:var(--primary);color:white;border:none;border-radius:20px;font-size:13px;cursor:pointer;font-weight:600">Sim, ajustar</button>
        <button onclick="fecharAjuste()" style="padding:10px 16px;background:var(--gray-200);color:var(--gray-700);border:none;border-radius:20px;font-size:13px;cursor:pointer;font-weight:600">Nao, esta otimo!</button>
      </div>
    `;

    row.appendChild(avatar);
    row.appendChild(msgDiv);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function continuarConversa() {
    const opcao = document.getElementById("ajuste-opcao");
    if (opcao) opcao.remove();

    fase = "conversando";
    addMessage("Claro! Me diz o que quer mudar na lista. Por exemplo:\n- \"Adiciona mais frutas\"\n- \"Remove o peixe\"\n- \"Troca frango por carne\"\n- \"Aumenta a quantidade de arroz\"");
    input.focus();
  }

  function fecharAjuste() {
    const opcao = document.getElementById("ajuste-opcao");
    if (opcao) opcao.remove();

    addMessage("Perfeito! Boas compras! Se precisar de algo mais, e so enviar uma nova dieta.");
    fase = "concluido";
  }

  async function baixarPdf() {
    if (!listaFinal) return;
    try {
      const res = await fetch(API_URL + "/gerar-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lista_compras: listaFinal })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "lista_compras.pdf";
      a.click();
      URL.revokeObjectURL(url);
      addMessage("PDF baixado!");
    } catch (e) {
      addMessage("Erro ao gerar PDF");
    }
  }

  // Event Listeners
  sendBtn.onclick = () => {
    if (fase === "tutorial") {
      startChat();
    } else if (fase === "inicial") {
      enviarDietaInicial();
    } else if (fase === "concluido") {
      // Se ja concluiu, comecar nova dieta
      fase = "inicial";
      dieta = null;
      historico = [];
      listaFinal = null;
      enviarDietaInicial();
    } else {
      enviarMensagemChat();
    }
  };

  input.onkeydown = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  };

  pdfBtn.onclick = () => pdfInput.click();
  pdfInput.onchange = () => {
    if (pdfInput.files.length) {
      if (fase === "tutorial") startChat();
      if (fase === "inicial") enviarDietaInicial();
    }
  };

  baixarPdfDesktop.onclick = baixarPdf;
  baixarPdfMobile.onclick = baixarPdf;

  // Auto-resize textarea
  input.oninput = () => {
    input.style.height = "auto";
    input.style.height = Math.min(input.scrollHeight, 120) + "px";
  };

  // Inicializacao
  showTutorial();

  // Health check
  fetch(API_URL + "/health").catch(() => addMessage("Servidor offline. Verifique se esta rodando."));
</script>

</body>
</html>
